import Payment from "../models/payment.model.js";
import PaymentLink from "../models/paymentLink.model.js";
import nodemailer from "nodemailer";
import dotenv from 'dotenv';
dotenv.config();
// 1️⃣ Create a new payment entry (Cash or Online)
export const createPayment = async (req, res) => {
  try {
    const { userId, amount, paymentMode, email, sentBy } = req.body;
 
    if (!userId || !amount || !paymentMode) {
      return res.status(400).json({ message: "Missing required fields" });
    }
 
    // CASE 1: CASH PAYMENT
    if (paymentMode === "Cash") {
      const payment = await Payment.create({
        userId,
        amount,
        paymentMode,
        status: "Pending",
      });
      return res.status(200).json({
        message: "Cash payment entry created successfully.",
        data: payment,
      });
    }
 
    // CASE 2: ONLINE PAYMENT
    if (paymentMode === "Online") {
      const paymentLinkData = {
        userId,
        amount,
        status: "Pending",
        email,
        upiId: "company@upi",
        qrCodeUrl: "https://yourserver.com/uploads/companyQR.png",
        paymentUrl: "https://your-payment-link.com/pay/" + userId,
        sentBy,
      };
 
      const paymentLink = await PaymentLink.create(paymentLinkData);
 
      // Send Email to user
      const transporter = nodemailer.createTransport({
      host: "smtp.gmail.com",
      port: 587,
        auth: {
          user: process.env.EMAIL_USER,
          pass: process.env.EMAIL_PASS,
        },
      });
 
      const mailOptions = {
        from: process.env.EMAIL_USER,
        to: email,
        subject: "Payment Link - Complete Your Payment",
        html: `
          <h2>Hello User,</h2>
          <p>Your payment link has been generated by <strong>${sentBy}</strong>.</p>
          <p><b>Amount:</b> ₹${amount}</p>
          <p><b>Company UPI ID:</b> ${paymentLinkData.upiId}</p>
          <p><b>Click below to make payment:</b></p>
          <a href="${paymentLinkData.paymentUrl}"
            style="background:#007bff; color:#fff; padding:10px 20px; text-decoration:none;">
            Pay Now
          </a>
          <p>You can also scan this QR code:</p>
          <img src="${paymentLinkData.qrCodeUrl}" width="150"/>
        `,
      };
 
      await transporter.sendMail(mailOptions);
 
      return res.status(200).json({
        message: "Online payment link sent successfully!",
        data: paymentLink,
      });
    }
 
    return res.status(400).json({ message: "Invalid payment mode" });
  } catch (error) {
    console.error("Error in createPayment:", error);
    res.status(500).json({ message: "Error creating payment", error });
  }
};
 
// 2️⃣ Update payment status (Cash received)
export const updatePaymentStatus = async (req, res) => {
  try {
    const { paymentId } = req.params;
    const { status } = req.body;
 
    const payment = await Payment.findByPk(paymentId);
    if (!payment) {
      return res.status(404).json({ message: "Payment not found" });
    }
 
    payment.status = status || "Completed";
    await payment.save();
 
    res.status(200).json({ message: "Payment status updated", data: payment });
  } catch (error) {
    res.status(500).json({ message: "Error updating payment status", error });
  }
};
 